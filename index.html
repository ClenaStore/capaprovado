<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel Financeiro • Aprovados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<style>
  :root{
    --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
    --teal:#06b6d4;--blue:#4f46e5;--green:#16a34a;--red:#ef4444;--amber:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink);font-size:15px}

  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f172a,#0b1220);
    border-bottom:1px solid var(--line);padding:14px;display:flex;flex-direction:column;gap:10px}
  header h1{font-size:18px;margin:0;font-weight:800}

  .controls{width:100%;display:flex;flex-direction:column;gap:8px}
  .row-filtros{display:flex;gap:8px;width:100%}
  .row-filtros select{flex:1}
  .row-linha{display:flex;gap:8px;width:100%}
  .row-linha input{flex:1}

  select,input{background:#0b1528;border:1px solid #22314b;color:var(--ink);
    padding:10px 14px;border-radius:10px;font-size:15px;width:100%}
  .btn{border:1px solid #2a3955;background:#0b1528;color:var(--ink);padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;font-size:15px;width:100%;position:relative;overflow:hidden}
  .btn.icon{display:flex;align-items:center;gap:6px;justify-content:center}

  #overlay{position:fixed;inset:0;background:rgba(3,7,18,.55);display:none;align-items:center;justify-content:center;z-index:100}
  .spinner{width:56px;height:56px;border:6px solid var(--teal);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  .container{padding:16px;max-width:1250px;margin:0 auto}
  .list-head{display:flex;align-items:center;justify-content:space-between;margin-top:10px;font-size:16px}
  .lista{display:grid;gap:14px;margin-top:14px}
  .titulo{background:linear-gradient(180deg,#101a2f,#0f172a);border:1px solid var(--line);
    border-radius:18px;padding:12px;display:grid;grid-template-columns:1fr;gap:10px;position:relative}
  .ck input{width:22px;height:22px}
  .row{display:flex;gap:10px;flex-wrap:wrap;font-size:14px;color:var(--muted)}
  .row b{color:var(--ink);font-size:15px}

  .pill{padding:6px 12px;border-radius:999px;border:1px solid #2a3955;background:#0b1528;font-size:13px;font-weight:800;
    position:absolute;top:8px;right:8px}
  .pill.liq{border-color:#155e32;color:#b6f3c5;background:#0e2a1b}
  .pill.flag{border-color:#f59e0b;color:#fff3c5;background:#2a1f0e}

  .actions{display:flex;gap:6px;flex-wrap:wrap}
  .mini{flex:1 1 calc(50% - 6px);padding:8px;border-radius:12px;border:1px solid #22314b;background:#0b1528;color:#fff;font-weight:700;cursor:pointer;font-size:14px;text-align:center}
  .mini.liq{background:linear-gradient(180deg,#19c37d,#16a34a)}
  .mini.flag{background:linear-gradient(180deg,#f59e0b,#b45309)}

  .footer{position:fixed;left:0;right:0;bottom:0;display:flex;flex-direction:column;gap:10px;align-items:stretch;z-index:15;padding:12px}
  .bubble{background:var(--blue);color:#fff;border-radius:12px;padding:12px 16px;font-weight:700;font-size:15px;text-align:center}
  .btn-massa{background:linear-gradient(180deg,var(--teal),#0796ad);color:#002027;border:0;border-radius:12px;padding:14px;font-weight:800;cursor:pointer;font-size:15px;width:100%}

  .menu{position:absolute;top:100%;right:0;background:#0f172a;border:1px solid var(--line);
    border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.4);display:none;z-index:30}
  .menu label{display:block;font-size:15px;margin:6px 0}
</style>
</head>
<body>
<header>
  <h1>Painel Financeiro • Aprovados</h1>
  <div class="controls">
    <div class="row-filtros">
      <select id="filtroMeio">
        <option value="Todos" selected>Todos</option>
        <option value="Pix">Pix</option>
        <option value="Cartão">Cartão</option>
        <option value="Boleto">Boleto</option>
        <option value="Outros">Outros</option>
      </select>
    </div>
    <div class="row-linha">
      <input type="text" id="filtroPeriodo" placeholder="Selecione período" />
      <div style="position:relative;flex:1">
        <button class="btn icon" id="btnEmpresas"><span id="empresaSelecionada">CAP DELICIA</span> ▼</button>
        <div id="menuEmpresas" class="menu"></div>
      </div>
    </div>
  </div>
</header>

<div id="overlay"><div class="spinner"></div></div>

<div class="container">
  <div class="list-head">
    <div><input id="master" type="checkbox" /> <b>Aprovados</b></div>
    <div id="contagem" style="color:var(--muted);font-size:14px">0 itens</div>
  </div>
  <div id="lista" class="lista"></div>
</div>

<div class="footer">
  <div id="bubble" class="bubble" style="display:none">Total selecionado: R$ 0,00</div>
  <button id="btnMassa" class="btn-massa" style="display:none">Liquidar selecionados</button>
</div>

<script>
const endpoint="https://script.google.com/macros/s/AKfycbzzLGp4BH0X3-mdhMqG_e07wrnUo9yFXUmJ8wdP9iVVgPxk1-tnmjsCIAEAb7r_0_yd/exec";
const EMP_DEFAULT=["CAP DELICIA","CAP VILLA","CAP PADARIA","CAP MERCATTO","CAP M.KIDS"];
let TITULOS={},SELEC=[];

const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso = d => {const dt=new Date(d);dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());return dt.toISOString().slice(0,10);};
const ID=(emp,linha)=>`${emp.replace(/\s+/g,'_')}__${linha}`;

function setPill(el,status){
  el.className="pill";
  if(status==="Liquidado"){el.classList.add("liq");el.textContent="Liquidado"}
  else if(status==="Flag"){el.classList.add("flag");el.textContent="Flag"}
  else el.textContent=status;
}

function toggleSel(chk){
  const card=chk.closest(".titulo");
  const id=card.dataset.id,valor=Number(card.dataset.valor)||0;
  if(chk.checked)SELEC.push({id,emp:card.dataset.emp,linha:card.dataset.linha,valor}); 
  else SELEC=SELEC.filter(x=>x.id!==id);
  const total=SELEC.reduce((s,x)=>s+x.valor,0);
  if(SELEC.length){$("bubble").style.display="block";$("btnMassa").style.display="block";$("bubble").textContent="Total selecionado: "+BRL(total)}
  else{$("bubble").style.display="none";$("btnMassa").style.display="none"}
}

async function mudarStatus(card,novo){
  const emp=card.dataset.emp,linha=card.dataset.linha;
  setPill(card.querySelector("[data-status]"),novo);
  try{
    await fetch(`${endpoint}?action=atualizar&empresa=${encodeURIComponent(emp)}&linha=${linha}&status=${encodeURIComponent(novo)}`);
  }catch(e){console.error(e)}
}

function renderLista(){
  const lista=$("lista");lista.innerHTML="";SELEC=[];$("master").checked=false;
  let totalItens=0;
  for(const emp of Object.keys(TITULOS)){
    (TITULOS[emp]||[]).forEach((t)=>{
      const st=t.status||"";
      if(st!=="Aprovado" && st!=="Liquidado" && st!=="Flag") return; // só aprovados e derivados
      totalItens++;
      const valor=Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",","."))||0;
      const id=ID(emp,t.linha);
      const card=document.createElement("div");
      card.className="titulo";card.dataset.id=id;card.dataset.emp=emp;card.dataset.linha=t.linha;card.dataset.valor=valor;
      card.innerHTML=`
        <div class="ck"><input type="checkbox" onchange="toggleSel(this)" /></div>
        <div class="info">
          <div class="row"><b>${t.fornecedor}</b> • ${emp}</div>
          <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> • Meio: <b>${t.meio_pagamento||"Outros"}</b></div>
          <div class="row">Valor: <b>${BRL(valor)}</b></div>
        </div>
        <span class="pill" data-status>${st}</span>
        <div class="actions">
          <button class="mini flag" onclick="mudarStatus(this.closest('.titulo'),'Flag')">⚑ Flegar</button>
          <button class="mini liq" onclick="mudarStatus(this.closest('.titulo'),'Liquidado')">✓ Liquidar</button>
        </div>`;
      setPill(card.querySelector("[data-status]"),st);
      lista.appendChild(card);
    });
  }
  $("contagem").textContent=`${totalItens} ${totalItens===1?"item":"itens"}`;
}

async function atualizarMassa(){
  for(const s of SELEC){
    const card=document.querySelector(`.titulo[data-id="${s.id}"]`);
    if(!card) continue;
    await mudarStatus(card,"Liquidado");
    card.querySelector(".ck input").checked=false;
  }
  SELEC=[];$("master").checked=false;
  $("bubble").style.display="none";$("btnMassa").style.display="none";
}
$("btnMassa").onclick=()=>atualizarMassa();

async function loadTitulos(empresas,inicio,fim,filtroMeio){
  TITULOS={};$("overlay").style.display="flex";
  const resps=await Promise.all(empresas.map(emp=>
    fetch(`${endpoint}?action=listar&empresa=${encodeURIComponent(emp)}`)
      .then(r=>r.json().then(d=>({emp,data:d.titulos||d})))
  ));
  resps.forEach(({emp,data})=>{
    const all=data.filter(t=>{const d=iso(t.vencimento);return (!inicio||d>=inicio)&&(!fim||d<=fim);});
    const arr=all.filter(t=>{
      let st=t.status||"";
      const meio=(t.meio_pagamento||"Outros");
      const meioOk=filtroMeio==="Todos"?true:(meio.toLowerCase().includes(filtroMeio.toLowerCase()));
      return meioOk && (st==="Aprovado"||st==="Liquidado"||st==="Flag");
    });
    TITULOS[emp]=arr;
  });
  $("overlay").style.display="none";
}

async function refresh(inicio,fim){
  const filtroMeio=$("filtroMeio").value;
  const empresa=document.querySelector("#menuEmpresas input:checked").value;
  await loadTitulos([empresa],inicio,fim,filtroMeio);
  $("empresaSelecionada").textContent=empresa;
  renderLista();
}

(function boot(){
  const hoje = iso(new Date());
  flatpickr("#filtroPeriodo", {
    mode: "range",dateFormat: "Y-m-d",locale: "pt",defaultDate: [hoje, hoje],
    onClose: sel=>{if(sel.length===2){const [ini,fim]=sel.map(d=>iso(d));refresh(ini,fim);}}
  });
  const M=$("menuEmpresas");
  EMP_DEFAULT.forEach((emp,i)=>{const lbl=document.createElement("label");lbl.innerHTML=`<input type="radio" name="empresaSel" value="${emp}" ${i===0?"checked":""}/> ${emp}`;lbl.querySelector("input").onchange=()=>{refresh(hoje,hoje);M.style.display="none"};M.appendChild(lbl);});
  $("btnEmpresas").onclick=(e)=>{e.stopPropagation();M.style.display=M.style.display==="block"?"none":"block";};
  document.addEventListener("click",(e)=>{if(!M.contains(e.target)&&e.target.id!=="btnEmpresas"){M.style.display="none";}});
  $("filtroMeio").onchange=()=>refresh(hoje,hoje);
  refresh(hoje,hoje);
})();
</script>
</body>
</html>
