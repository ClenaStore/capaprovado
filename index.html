<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel Financeiro • CAP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
    --teal:#06b6d4;--blue:#4f46e5;--green:#16a34a;--red:#ef4444;--amber:#f59e0b;--chip:#101a2e}
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui;color:var(--ink);background:linear-gradient(180deg,#0b1220 0,#0a0f1a 100%)}
  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f172a,#0b1220);
    border-bottom:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  header h1{font-size:16px;margin:0;font-weight:800}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  select,input[type="date"]{background:#0b1528;border:1px solid #22314b;color:var(--ink);
    padding:8px 10px;border-radius:10px;font-size:13px}
  .btn{border:1px solid #2a3955;background:#0b1528;color:var(--ink);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
  .btn.icon{display:flex;align-items:center;gap:6px}
  #overlay{position:fixed;inset:0;background:rgba(3,7,18,.55);display:none;align-items:center;justify-content:center;z-index:100}
  .spinner{width:48px;height:48px;border:6px solid var(--teal);border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .container{padding:12px;max-width:1100px;margin:0 auto}
  .saldos{display:flex;gap:10px;overflow:auto;padding-bottom:6px;scrollbar-width:thin;scroll-snap-type:x mandatory}
  @media(min-width:1024px){.saldos{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;overflow:visible}}
  .saldo-card{min-width:220px;background:linear-gradient(180deg,#121b31,#0e1528);border:1px solid var(--line);border-radius:14px;padding:10px}
  .saldo-card h3{margin:0 0 2px;font-size:12px;color:#9eb6ff}
  .saldo-card .f{margin-top:4px;font-weight:800}
  .saldo-card .ok{color:var(--green)} .saldo-card .bad{color:var(--red)}
  .viz{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
  .card{background:#0f172a;border:1px solid var(--line);border-radius:14px;padding:10px}
  .chart-card{flex:0 0 220px;max-width:220px;text-align:center}
  .mods-card{flex:1 1 260px}
  .mods{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .mod{background:var(--chip);border:1px solid #22314b;border-radius:12px;padding:8px;font-size:13px;display:flex;justify-content:space-between}
  .list-head{display:flex;align-items:center;justify-content:space-between;margin-top:6px}
  .lista{display:grid;gap:10px;margin-top:10px}
  .titulo{background:linear-gradient(180deg,#101a2f,#0f172a);border:1px solid var(--line);border-radius:14px;padding:10px;display:grid;grid-template-columns:auto 1fr auto;gap:10px}
  .ck input{width:18px;height:18px}
  .row{display:flex;gap:8px;flex-wrap:wrap;font-size:12px;color:var(--muted)} .row b{color:var(--ink)}
  .pill{padding:4px 8px;border-radius:999px;border:1px solid #2a3955;background:#0b1528;font-size:12px;font-weight:800}
  .pill.ok{border-color:#155e32;color:#b6f3c5;background:#0e2a1b}
  .pill.warn{border-color:#7a1e1e;color:#ffb4b4;background:#2a0e0e}
  .actions{display:flex;gap:6px;align-items:center}
  .mini{padding:6px 9px;border-radius:10px;background:#0b1528;color:var(--ink);font-weight:800;cursor:pointer}
  .mini.aprovar{background:linear-gradient(180deg,#19c37d,#16a34a)}
  .mini.negar{background:linear-gradient(180deg,#fb6969,#ef4444)}
  .mini.hist{background:linear-gradient(180deg,#ffd166,#f59e0b)}
  .mini.obs{background:linear-gradient(180deg,#60a5fa,#1d4ed8)}
  .footer{position:fixed;right:12px;bottom:12px;display:flex;flex-direction:column;gap:10px;align-items:flex-end}
  .bubble{background:var(--blue);color:#fff;border-radius:12px;padding:8px 12px;font-weight:800}
  .btn-massa{background:linear-gradient(180deg,var(--teal),#0796ad);color:#002027;border:0;border-radius:12px;padding:10px 14px;font-weight:900}
  .menu{position:fixed;top:60px;right:10px;background:#0f172a;border:1px solid var(--line);border-radius:12px;padding:10px;display:none;z-index:30}
  .modal{position:fixed;inset:0;background:rgba(2,6,15,.65);display:none;align-items:center;justify-content:center;z-index:50}
  .modal .box{background:#0f172a;border:1px solid var(--line);border-radius:12px;max-width:90%;width:420px;padding:12px}
  textarea{width:100%;min-height:80px;background:#0b1528;border:1px solid #22314b;color:#fff;border-radius:8px;padding:6px}
</style>
</head>
<body>
<header>
  <h1>Painel Financeiro • CAP</h1>
  <div class="controls">
    <label>Status:</label>
    <select id="filtroStatus">
      <option value="Pendente" selected>Pendentes</option>
      <option value="Aprovado">Aprovados</option>
      <option value="Negado">Negados</option>
      <option value="Liquidado">Liquidados</option>
      <option value="Todos">Todos</option>
    </select>
    <input type="date" id="filtroData" />
    <button class="btn icon" id="btnEmpresas">Empresas ⚙</button>
  </div>
</header>

<div id="overlay"><div class="spinner"></div></div>
<div id="menuEmpresas" class="menu"></div>

<div class="container">
  <div id="saldos" class="saldos"></div>
  <div class="viz">
    <div class="card chart-card"><canvas id="grafico"></canvas><div id="totaisGraf"></div></div>
    <div class="card mods-card"><b>Modalidades</b><div id="mods" class="mods"></div></div>
  </div>
  <div class="list-head"><div><input id="master" type="checkbox" /> <b>Títulos do dia</b></div><div id="contagem"></div></div>
  <div id="lista" class="lista"></div>
</div>

<div class="footer"><div id="bubble" class="bubble" style="display:none"></div><button id="btnMassa" class="btn-massa" style="display:none">Aprovar selecionados</button></div>

<!-- Modal Observação -->
<div id="modalObs" class="modal"><div class="box"><button onclick="fecharObs()" class="btn">Fechar</button><h3>Observação</h3><textarea id="textoObs"></textarea><button class="btn" onclick="salvarObs()">Salvar</button></div></div>

<!-- Modal Histórico -->
<div id="modalHist" class="modal"><div class="box"><button onclick="fecharHist()" class="btn">Fechar</button><h3>Histórico</h3><div id="histBody"></div></div></div>

<script>
const endpointTitulos="SEU_ENDPOINT_TITULOS";
const endpointSaldos="SEU_ENDPOINT_SALDOS";
const EMP_DEFAULT=["CAP DELICIA","CAP VILLA","CAP PADARIA","CAP MERCATTO","CAP M.KIDS"];
let SALDOS={},TITULOS={},SELEC=[],CHART,obsContext={};
const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso=d=>new Date(d).toISOString().slice(0,10);
const ID=(emp,idx)=>`${emp.replace(/\s+/g,'_')}__${idx}`;

async function loadSaldos(){const r=await fetch(endpointSaldos);const d=await r.json();SALDOS={};d.forEach(x=>{SALDOS[x.Empresa.trim().toUpperCase()]=Number(x.Saldo)||0})}
async function loadTitulos(empresas,diaISO,filtro){TITULOS={};const resps=await Promise.all(empresas.map(emp=>fetch(`${endpointTitulos}?action=listar&empresa=${encodeURIComponent(emp)}`).then(r=>r.json().then(d=>({emp,data:d.titulos||d})))));resps.forEach(({emp,data})=>{const all=data.filter(t=>iso(t.vencimento)===diaISO);const arr=all.filter(t=>{let st=(t.status==="Sim"?"Pendente":t.status);return(filtro==="Todos"?true:st===filtro)});TITULOS[emp]=arr;TITULOS[emp+"_ALL"]=all})}
function setPill(el,status){el.className="pill";if(status==="Aprovado"){el.classList.add("ok");el.textContent="Aprovado"}else if(status==="Negado"){el.classList.add("warn");el.textContent="Negado"}else el.textContent=status}
function renderLista(){const lista=$("lista");lista.innerHTML="";SELEC=[];$("master").checked=false;let totalItens=0,somaModal={};for(const emp of Object.keys(TITULOS)){if(emp.endsWith("_ALL"))continue;const arr=TITULOS[emp]||[];arr.forEach((t,idx)=>{totalItens++;const valor=Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",",".") )||0;const id=ID(emp,idx);const st=(t.status==="Sim"?"Pendente":t.status);const card=document.createElement("div");card.className="titulo";card.dataset.id=id;card.dataset.emp=emp;card.dataset.idx=idx;card.dataset.valor=valor;card.innerHTML=`<div class="ck"><input type="checkbox" onchange="toggleSel(this)" /></div><div class="info"><div class="row"><b>${t.fornecedor}</b> • ${emp}</div><div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> • Meio: <b>${t.meio_pagamento}</b></div><div class="row">Valor: <b>${BRL(valor)}</b> <span class="pill" data-status>${st}</span></div>${t.observacao?`<div><b>Obs:</b> ${t.observacao}</div>`:""}${t.historico?`<div><b>Histórico:</b><br>${t.historico}</div>`:""}</div><div class="actions"><button class="mini obs" onclick="abrirObs('${id}','${emp}',${idx})">✏️</button><button class="mini aprovar" onclick="acaoStatus(this,'Aprovado')">✓</button><button class="mini negar" onclick="acaoStatus(this,'Negado')">✗</button><button class="mini hist" onclick="abrirHist('${id}')">H</button></div>`;setPill(card.querySelector("[data-status]"),st);lista.appendChild(card)})}$("contagem").textContent=`${totalItens} itens`}
function abrirObs(id,emp,idx){obsContext={id,emp,idx,card:document.querySelector(`.titulo[data-id="${id}"]`)};$("modalObs").style.display="flex"}
function fecharObs(){$("modalObs").style.display="none"}
async function salvarObs(){const {emp,idx,card}=obsContext;const texto=$("textoObs").value.trim();await fetch(`${endpointTitulos}?action=atualizarObservacao&empresa=${encodeURIComponent(emp)}&index=${idx}&texto=${encodeURIComponent(texto)}`);let obsEl=card.querySelector(".obsText");if(!obsEl){obsEl=document.createElement("div");obsEl.className="obsText";card.querySelector(".info").appendChild(obsEl)}obsEl.innerHTML=`<b>Obs:</b> ${texto}`;fecharObs()}
function abrirHist(id){const arr=JSON.parse(localStorage.getItem("hist_"+id)||"[]");$("histBody").textContent=arr.length?arr.map(x=>`${x.data} — ${x.acao} — ${BRL(x.valor)}`).join("\n"):"Sem histórico.";$("modalHist").style.display="flex"}
function fecharHist(){$("modalHist").style.display="none"}
function addHist(id,acao,valor){const arr=JSON.parse(localStorage.getItem("hist_"+id)||"[]");arr.push({data:new Date().toLocaleString("pt-BR"),acao,valor});localStorage.setItem("hist_"+id,JSON.stringify(arr))}
async function acaoStatus(btn,novo){const card=btn.closest(".titulo");const emp=card.dataset.emp,idx=card.dataset.idx;btn.classList.add("loading");setPill(card.querySelector("[data-status]"),novo);addHist(card.dataset.id,novo,card.dataset.valor);await fetch(`${endpointTitulos}?action=atualizar&empresa=${encodeURIComponent(emp)}&index=${idx}&status=${encodeURIComponent(novo)}`);btn.classList.remove("loading")}
$("btnMassa").onclick=async()=>{const bt=$("btnMassa");bt.classList.add("loading");for(const s of SELEC){const card=document.querySelector(`.titulo[data-id="${s.id}"]`);if(!card)continue;await acaoStatus(card.querySelector(".mini.aprovar"),"Aprovado");card.querySelector("input[type=checkbox]").checked=false}SELEC=[];$("master").checked=false;renderSelecionados();bt.classList.remove("loading")}
$("master").onchange=()=>{document.querySelectorAll("#lista input[type=checkbox]").forEach(cb=>{cb.checked=$("master").checked;cb.dispatchEvent(new Event("change"))})}
function toggleSel(chk){const card=chk.closest(".titulo");const id=card.dataset.id,emp=card.dataset.emp,idx=Number(card.dataset.idx),valor=Number(card.dataset.valor)||0;if(chk.checked)SELEC.push({id,emp,idx,valor});else SELEC=SELEC.filter(x=>x.id!==id);renderSelecionados()}
function renderSelecionados(){const total=SELEC.reduce((s,x)=>s+x.valor,0);if(SELEC.length){$("bubble").style.display="block";$("btnMassa").style.display="block";$("bubble").textContent="Total: "+BRL(total)}else{$("bubble").style.display="none";$("btnMassa").style.display="none"}}
async function refresh(){const diaISO=$("filtroData").value,filtro=$("filtroStatus").value;const empresas=[...document.querySelectorAll("#menuEmpresas input:checked")].map(i=>i.value);await loadSaldos();await loadTitulos(empresas,diaISO,filtro);renderLista()}
(function boot(){const hoje=new Date().toISOString().slice(0,10);$("filtroData").value=hoje;EMP_DEFAULT.forEach(emp=>{const lbl=document.createElement("label");lbl.innerHTML=`<input type="checkbox" value="${emp}" checked/> ${emp}`;lbl.querySelector("input").onchange=refresh;$("menuEmpresas").appendChild(lbl)});$("filtroStatus").onchange=refresh;$("filtroData").onchange=refresh;refresh()})();
</script>
</body>
</html>
