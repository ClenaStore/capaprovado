<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CAP APROVADO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<style>
  :root{
    --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
    --green:#16a34a;--red:#ef4444;--amber:#f59e0b;--blue:#3b82f6;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink);font-size:15px}

  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f172a,#0b1220);
    border-bottom:1px solid var(--line);padding:14px}
  header h1{font-size:18px;margin:0 0 12px 0;font-weight:800}

/* Cabe√ßalho compacto */
.row-filtros{
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4 colunas lado a lado */
  gap: 8px;
  margin-bottom: 8px;
}

.row-filtros select,
.row-filtros input {
  width: 100%; /* cada filtro ocupa sua c√©lula */
}

/* Responsividade */
@media (max-width: 900px) {
  .row-filtros { grid-template-columns: 1fr 1fr; } /* 2 colunas no tablet */
}
@media (max-width: 600px) {
  .row-filtros { grid-template-columns: 1fr; }     /* 1 coluna no celular */
}

  select,input{background:#0b1528;border:1px solid #22314b;color:var(--ink);
    padding:10px 14px;border-radius:10px;font-size:15px;width:100%}

  .statusResumoWrapper{display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-left:4px}
  .statusResumo{display:flex;gap:16px;flex-wrap:wrap}
  .statusResumo div{font-size:14px;font-weight:600}
  .statusResumo .aprovado{color:var(--green)}
  .statusResumo .pendente{color:var(--amber)}
  .statusResumo .negado{color:var(--red)}
  .statusResumo .liquidado{color:var(--blue)}

  .mini-spinner{
    width:16px;height:16px;
    border:2px solid var(--ink);
    border-top-color:transparent;
    border-radius:50%;
    animation:spin 0.8s linear infinite;
    display:none;
  }
  .mini-spinner.active{display:inline-block;}
  #lastUpdate{font-size:12px;color:var(--muted)}

  .container{padding:16px;max-width:100%;margin:0 auto}
  .lista{display:flex;flex-direction:column;gap:16px;width:100%}

  .titulo{
    width:95%;
    margin:0 auto;
    background:#101a2f;
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px 16px;
    display:flex;
    flex-direction:column;
    gap:4px;
    position:relative;
  }

  .topo{display:flex;align-items:center;justify-content:space-between}
  .ck{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:13px}
  .ck input{width:18px;height:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap;font-size:14px;color:var(--muted);word-break:break-word}
  .row b{color:var(--ink);font-size:15px}

  .pill{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .pill.aprovado{background:#0e2a1b;color:#b6f3c5;border:1px solid #155e32}
  .pill.negado{background:#2a0e0e;color:#ffb4b4;border:1px solid #7a1e1e}
  .pill.pendente{background:#2a2a0e;color:#fff2b2;border:1px solid #b59d00}
  .pill.liquidado{background:#0b2a3d;color:#b2d8ff;border:1px solid #2563eb}

  .acoes{display:flex;justify-content:flex-end;margin-top:6px}
  .btn{padding:6px 12px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;border:0;position:relative}
  .liquidar{background:linear-gradient(180deg,#19c37d,#16a34a);color:#fff}

  .footer{position:fixed;left:0;right:0;bottom:0;padding:12px;background:#0f172a;border-top:1px solid var(--line);
    display:flex;justify-content:flex-end}
  .btn-massa {
    background: linear-gradient(180deg,#19c37d,#16a34a);
    color: #fff;
    border: 0;
    border-radius: 6px;
    padding: 8px 14px;
    font-weight: 700;
    cursor: pointer;
    font-size: 13px;
    position: relative;
    display: none; /* escondido por padr√£o */
  }
  .btn-massa.show {
    display: inline-block; /* aparece quando tiver sele√ß√£o */
  }

  /* spinner dentro do bot√£o */
  .btn.loading {color: transparent !important;pointer-events: none;}
  .btn.loading::after {
    content: "";position: absolute;top: 50%;left: 50%;
    width: 16px;height: 16px;margin: -8px 0 0 -8px;
    border: 2px solid #fff;border-top-color: transparent;
    border-radius: 50%;animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* overlay global */
  #overlay {
    position: fixed;top:0;left:0;right:0;bottom:0;
    background: rgba(11,18,32,0.9);
    display:flex;justify-content:center;align-items:center;
    z-index:1000;visibility:hidden;opacity:0;
    transition:opacity 0.3s ease;
  }
  #overlay.active {visibility:visible;opacity:1;}
  #overlay::after {
    content:"";width:40px;height:40px;
    border:4px solid #fff;border-top-color:transparent;
    border-radius:50%;animation:spin 1s linear infinite;
  }

  /* --- Totais --- */
  #totaisWrapper {
    margin: 12px 0;
    display: none;
  }
  #totaisWrapper.active {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .total-card {
    flex: 1 1 45%;
    background: #101a2f;
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 10px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 700;
    font-size: 14px;
    color: var(--ink);
  }
</style>
</head>
<body>
<header>
  <h1>CAP APROVADO</h1>
  <div class="row-filtros">
    <select id="filtroStatus">
      <option value="Aprovado" selected>Aprovados</option>
      <option value="Negado">Negados</option>
      <option value="Pendente">Pendentes</option>
      <option value="Liquidado">Liquidados</option>
    </select>
    <select id="filtroMeio">
      <option value="Todos" selected>Todos</option>
      <option value="Pix">Pix</option>
      <option value="Cart√£o">Cart√£o</option>
      <option value="Boleto">Boleto</option>
      <option value="Outros">Outros</option>
    </select>
    <input type="text" id="filtroPeriodo" placeholder="Selecione per√≠odo" />
    <select id="filtroEmpresa">
      <option value="cap delicia">DEL√çCIA GOURMET</option>
      <option value="cap villa">VILLA GOURMET</option>
      <option value="cap padaria">PADARIA DEL√çCIA</option>
      <option value="cap mercatto">MERCATTO</option>
      <option value="cap m.kids">M.KIDS</option>
    </select>
  </div>

  <!-- Bot√£o Ver Totais -->
  <div style="margin-top:8px;">
    <button id="btnTotais" class="btn" style="background:#22314b;color:#fff;width:100%;border-radius:8px;padding:10px;">
      üìä Ver Totais
    </button>
  </div>
  <div id="totaisWrapper"></div>

  <div class="statusResumoWrapper">
    <div id="statusResumo" class="statusResumo"></div>
    <div id="miniSpinner" class="mini-spinner"></div>
    <div id="lastUpdate"></div>
  </div>
</header>

<div class="container">
  <div id="lista" class="lista"></div>
</div>

<div class="footer">
  <button id="btnMassa" class="btn-massa">‚úì Liquidar Selecionados</button>
</div>

<div id="overlay"></div>

<script>
const endpoint="https://script.google.com/macros/s/AKfycbzJS4UkF6WZ-duyMJW_h3e5fo4Hev6Hq1a7rGhWNYCNJ6V_ou0lkN6wS49eeANf4Yuy/exec";
const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso = d => {const dt=new Date(d);dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());return dt.toISOString().slice(0,10);};

let TITULOS=[],SELEC=[];

function salvarSelecoes(){const ids=SELEC.map(c=>c.dataset.linha+"|"+c.dataset.emp);localStorage.setItem("titulosSelecionados",JSON.stringify(ids));}
function restaurarSelecoes(){const ids=JSON.parse(localStorage.getItem("titulosSelecionados")||"[]");ids.forEach(id=>{const [linha,emp]=id.split("|");const card=document.querySelector(`.titulo[data-linha="${linha}"][data-emp="${emp}"]`);if(card){const chk=card.querySelector("input[type=checkbox]");chk.checked=true;if(!SELEC.includes(card))SELEC.push(card);}});}

function renderLista(){
  const lista=$("lista");lista.innerHTML="";SELEC=[];
  const abaSelecionada=$("filtroEmpresa").value;
  TITULOS.forEach(t=>{
    const card=document.createElement("div");
    card.className="titulo";
    card.dataset.linha=t.linha;
    card.dataset.emp=abaSelecionada;
    card.dataset.status=t.status;
    const valor=Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",","."))||0;
    card.dataset.valor=valor;
    let st=t.status||"";let pillClass=st.toLowerCase();
    const historico=(t.historico||"").toString().trim().replace(/\n/g,"<br>");
    const obs=(t.observacao??"").toString().trim().replace(/\n/g,"<br>");
    card.innerHTML=`
      <div class="topo">
        <label class="ck"><input type="checkbox" onchange="toggleSel(this)"> Selecionar</label>
        <span class="pill ${pillClass}">${st}</span>
      </div>
      <div><b>${t.fornecedor||"-"}</b> ‚Ä¢ ${t.empresa||"-"}</div>
      <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> ‚Ä¢ Meio: <b>${t.meio_pagamento||"Outros"}</b></div>
      <div class="row">Valor: <b>${BRL(valor)}</b></div>
      <div class="row">Hist√≥rico: <b>${historico||"-"}</b></div>
      <div class="row">Obs de Leonardo: <b>${obs||"-"}</b></div>
      <div class="acoes">
        <button class="btn liquidar" onclick="liquidar(this)" ${st!=="Aprovado"?"disabled style='opacity:0.5;cursor:not-allowed'":""}>‚úì Liquidar</button>
      </div>`;
    lista.appendChild(card);
  });
  restaurarSelecoes();
  atualizarBtnMassa();
}

function toggleSel(chk){
  const card=chk.closest(".titulo");
  if(chk.checked){
    if(card.dataset.status==="Aprovado"){
      SELEC.push(card);
    }else{
      chk.checked=false;
      alert("Somente t√≠tulos aprovados podem ser liquidados.");
    }
  }else{
    SELEC=SELEC.filter(c=>c!==card);
  }
  salvarSelecoes();
  atualizarBtnMassa();
}

async function liquidar(btn){
  const card=btn.closest(".titulo");
  if(card.dataset.status!=="Aprovado"){
    alert("Somente t√≠tulos aprovados podem ser liquidados.");return;
  }
  const emp=card.dataset.emp,linha=card.dataset.linha;
  try{
    btn.classList.add("loading");
    const r=await fetch(`${endpoint}?action=atualizar&empresa=${encodeURIComponent(emp)}&linha=${linha}&status=Liquidado`);
    const txt=await r.text();
    if(txt.includes("sucesso")||txt.includes("success")){
      card.querySelector(".pill").textContent="Liquidado";
      card.querySelector(".pill").className="pill liquidado";
      card.dataset.status="Liquidado";
      btn.disabled=true;btn.style.opacity="0.5";
    }else{alert("Erro ao liquidar t√≠tulo. Resposta: "+txt);}
    salvarSelecoes();
  }catch(e){console.error(e);}
  finally{btn.classList.remove("loading");}
}

async function liquidarMassa(){
  const btnMassa=$("btnMassa");
  btnMassa.classList.add("loading");
  for(const card of SELEC){
    if(card.dataset.status!=="Aprovado")continue;
    const emp=card.dataset.emp,linha=card.dataset.linha;
    const btn=card.querySelector(".btn.liquidar");
    try{
      if(btn) btn.classList.add("loading");
      const r=await fetch(`${endpoint}?action=atualizar&empresa=${encodeURIComponent(emp)}&linha=${linha}&status=Liquidado`);
      const txt=await r.text();
      if(txt.includes("sucesso")||txt.includes("success")){
        card.querySelector(".pill").textContent="Liquidado";
        card.querySelector(".pill").className="pill liquidado";
        card.dataset.status="Liquidado";
        if(btn){btn.disabled=true;btn.style.opacity="0.5";}
      }
    }catch(e){console.error(e);}
    finally{if(btn) btn.classList.remove("loading");}
  }
  SELEC=[];salvarSelecoes();btnMassa.classList.remove("loading");
  atualizarBtnMassa();
}
$("btnMassa").onclick=liquidarMassa;

async function refresh(auto=false){
  if(auto){$("miniSpinner").classList.add("active");}
  else{$("overlay").classList.add("active");}
  const status=$("filtroStatus").value;
  const meio=$("filtroMeio").value;
  const empresa=$("filtroEmpresa").value;
  const periodo=$("filtroPeriodo").value;
  const [ini,fim]=periodo.includes(" to ")?periodo.split(" to "):[periodo,periodo];
  try{
    const r=await fetch(`${endpoint}?action=listar&empresa=${encodeURIComponent(empresa)}`);
    const data=await r.json();
    TITULOS=(data.titulos||data).filter(t=>{
      const d=iso(t.vencimento);const st=t.status||"";const mp=(t.meio_pagamento||"Outros");
      return (!status||st===status)&&(meio==="Todos"||mp===meio)&&(!ini||d>=ini)&&(!fim||d<=fim);
    });
    renderLista();atualizarResumo(data.titulos||data);
    $("lastUpdate").textContent="√öltima atualiza√ß√£o: "+new Date().toLocaleTimeString("pt-BR");
  }catch(e){console.error(e);}
  finally{
    if(auto){$("miniSpinner").classList.remove("active");}
    else{$("overlay").classList.remove("active");}
  }
}

function atualizarResumo(dados){
  const counts={Aprovado:0,Pendente:0,Negado:0,Liquidado:0};
  dados.forEach(t=>{if(counts[t.status]!==undefined)counts[t.status]++;});
  const total=Object.values(counts).reduce((a,b)=>a+b,0);
  const resumo=$("statusResumo");
  resumo.innerHTML="";
  Object.entries(counts).forEach(([status,qtd])=>{
    const perc=total?((qtd/total)*100).toFixed(1):0;
    const div=document.createElement("div");
    div.className=status.toLowerCase();
    div.textContent=`${status}: ${perc}%`;
    resumo.appendChild(div);
  });
}

function atualizarBtnMassa(){
  const btnMassa = $("btnMassa");
  if(SELEC.length > 0){
    btnMassa.classList.add("show");
  } else {
    btnMassa.classList.remove("show");
  }
}

/* --- Totais --- */
$("btnTotais").onclick = () => {
  const wrapper = $("totaisWrapper");
  wrapper.classList.toggle("active");

  if(wrapper.classList.contains("active")){
    const totais = {};
    TITULOS.filter(t => t.status !== "Negado").forEach(t => {
      const meio = t.meio_pagamento || "Outros";
      const valor = Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",",".")) || 0;
      totais[meio] = (totais[meio] || 0) + valor;
    });

    wrapper.innerHTML = "";
    Object.entries(totais).forEach(([meio, valor]) => {
      const card = document.createElement("div");
      card.className = "total-card";
      card.innerHTML = `<span>${meio}</span><span>${BRL(valor)}</span>`;
      wrapper.appendChild(card);
    });

    const totalGeral = Object.values(totais).reduce((a,b)=>a+b,0);
    const cardTotal = document.createElement("div");
    cardTotal.className = "total-card";
    cardTotal.style.background = "linear-gradient(90deg,var(--blue),var(--green))";
    cardTotal.innerHTML = `<span>Total</span><span>${BRL(totalGeral)}</span>`;
    wrapper.appendChild(cardTotal);
  }
};

(function boot(){
  const hoje=iso(new Date());
  flatpickr("#filtroPeriodo",{mode:"range",dateFormat:"Y-m-d",defaultDate:[hoje,hoje],onClose:()=>refresh(false)});
  ["filtroStatus","filtroMeio","filtroEmpresa"].forEach(id=>{$(id).onchange=()=>refresh(false);});
  refresh(false);
  setInterval(()=>refresh(true),10*1000); // auto refresh 10s
})();
</script>
</body>
</html>
