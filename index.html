<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>CAP APROVADO</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
<style>
  :root{
    --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
    --green:#16a34a;--blue:#3b82f6;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink);font-size:15px}

  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f172a,#0b1220);
    border-bottom:1px solid var(--line);padding:14px}
  header h1{font-size:18px;margin:0 0 12px 0;font-weight:800}

.row-filtros{
  display: grid;
  grid-template-columns: 1fr 150px 180px 160px;
  gap: 8px;
  margin-bottom: 8px;
}

.row-filtros select,
.row-filtros input {
  background:#0b1528;
  border:1px solid #22314b;
  color:var(--ink);
  padding:8px 10px;
  border-radius:8px;
  font-size:14px;
  width:100%;
}

  @media (max-width: 900px) {
    .row-filtros { grid-template-columns: 1fr 1fr; }
  }
  @media (max-width: 600px) {
    .row-filtros { grid-template-columns: 1fr; }
  }

.statusResumoWrapper {
  display: flex;
  align-items: center;
  gap: 16px;
  margin-bottom: 12px;
  padding-left: 4px;
  flex-wrap: wrap;
}
.statusResumo{display:flex;gap:16px;flex-wrap:wrap}
.statusResumo div{font-size:14px;font-weight:600;color:var(--green)}

#miniSpinner {
  width: 14px;
  height: 14px;
  border: 2px solid var(--ink);
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  display: none;
}
#miniSpinner.active {display:inline-block;}

#lastUpdate {
  font-size: 13px;
  color: var(--muted);
  display: flex;
  align-items: center;
  gap: 6px;
}
#barraPesquisa {
  background:#0b1528;
  border:1px solid #22314b;
  color:var(--ink);
  padding:8px 10px;
  border-radius:8px;
  font-size:14px;
  width:100%;
}

.container{padding:16px;max-width:100%;margin:0 auto}
.lista{display:flex;flex-direction:column;gap:16px;width:100%}

.titulo {
  width:95%;
  margin:0 auto;
  background:#101a2f;
  border:1px solid var(--line);
  border-radius:8px;
  padding:8px 12px;
  display:flex;
  flex-direction:column;
  gap:4px;
  position:relative;
}
.row{display:flex;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--muted);word-break:break-word}
.row b{color:var(--ink);font-size:14px}

#overlay {
  position: fixed;top:0;left:0;right:0;bottom:0;
  background: rgba(11,18,32,0.9);
  display:flex;justify-content:center;align-items:center;
  z-index:1000;visibility:hidden;opacity:0;
  transition:opacity 0.3s ease;
}
#overlay.active {visibility:visible;opacity:1;}
#overlay::after {
  content:"";width:40px;height:40px;
  border:4px solid #fff;border-top-color:transparent;
  border-radius:50%;animation:spin 1s linear infinite;
}

#totaisWrapper {
  margin: 12px 0;
  display: none;
}
#totaisWrapper.active {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
}
.total-card {
  flex: 1 1 45%;
  background: #101a2f;
  border: 1px solid var(--line);
  border-radius: 10px;
  padding: 10px 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-weight: 700;
  font-size: 14px;
  color: var(--ink);
}
</style>
</head>
<body>
<header>
  <h1>CAP APROVADO</h1>
<div class="row-filtros">
  <input type="text" id="barraPesquisa" placeholder="üîç Pesquisar..." />
  
  <select id="filtroMeio">
    <option value="Todos" selected>Todos</option>
    <option value="Pix">Pix</option>
    <option value="Cart√£o">Cart√£o</option>
    <option value="Boleto">Boleto</option>
    <option value="Outros">Outros</option>
  </select>

  <input type="text" id="filtroPeriodo" placeholder="Selecione per√≠odo" />
  <select id="filtroEmpresa">
    <option value="cap delicia">DEL√çCIA GOURMET</option>
    <option value="cap villa">VILLA GOURMET</option>
    <option value="cap padaria">PADARIA DEL√çCIA</option>
    <option value="cap mercatto">MERCATTO</option>
    <option value="cap m.kids">M.KIDS</option>
  </select>
</div>
  <div style="margin-top:8px;">
    <button id="btnTotais" class="btn" style="background:#22314b;color:#fff;width:100%;border-radius:8px;padding:10px;">
      üìä Ver Totais
    </button>
  </div>
  <div id="totaisWrapper"></div>
<div class="statusResumoWrapper">
  <div id="lastUpdate"></div>
  <div id="statusResumo" class="statusResumo"></div>
  <div id="miniSpinner"></div>
</div>
</header>

<div class="container">
  <div id="lista" class="lista"></div>
</div>

<div id="overlay"></div>

<script>
const endpoint="https://script.google.com/macros/s/AKfycbzJS4UkF6WZ-duyMJW_h3e5fo4Hev6Hq1a7rGhWNYCNJ6V_ou0lkN6wS49eeANf4Yuy/exec";
const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso = d => {const dt=new Date(d);dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());return dt.toISOString().slice(0,10);};

let TITULOS=[];

function renderLista(){
  const lista=$("lista");lista.innerHTML="";
  const termo = $("barraPesquisa").value.toLowerCase();
  TITULOS
    .filter(t => {
      return !termo || 
             (t.fornecedor && t.fornecedor.toLowerCase().includes(termo)) ||
             (t.empresa && t.empresa.toLowerCase().includes(termo)) ||
             (t.meio_pagamento && t.meio_pagamento.toLowerCase().includes(termo));
    })
    .forEach(t=>{
      const card=document.createElement("div");
      card.className="titulo";
      const valor=Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",","."))||0;
      const historico=(t.historico||"").toString().trim().replace(/\n/g,"<br>");
      const obs=(t.observacao??"").toString().trim().replace(/\n/g,"<br>");
      card.innerHTML=`
        <div><b>${t.fornecedor||"-"}</b> ‚Ä¢ ${t.empresa||"-"}</div>
        <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> ‚Ä¢ Meio: <b>${t.meio_pagamento||"Outros"}</b></div>
        <div class="row">Valor: <b>${BRL(valor)}</b></div>
        <div class="row">Hist√≥rico: <b>${historico||"-"}</b></div>
        <div class="row">Obs de Leonardo: <b>${obs||"-"}</b></div>`;
      lista.appendChild(card);
    });
}

function toDate(str){
  if (!str) return null;
  if (str.includes("-")) { return new Date(str+"T00:00:00"); }
  else { const [d,m,y] = str.split("/"); return new Date(`${y}-${m}-${d}T00:00:00`); }
}

async function refresh(auto=false){
  if(auto){$("miniSpinner").classList.add("active");}
  else{$("overlay").classList.add("active");}
  const meio=$("filtroMeio").value;
  const empresa=$("filtroEmpresa").value;

  try{
    const r=await fetch(`${endpoint}?action=listar&empresa=${encodeURIComponent(empresa)}`);
    const data=await r.json();
    const todos = data.titulos || data;

    const periodo=$("filtroPeriodo").value;
    const [ini,fim] = periodo.includes(" at√© ") ? periodo.split(" at√© ") : [periodo,periodo];

    TITULOS = todos.filter(t => {
      const d = toDate(iso(t.vencimento));
      const st = t.status || "";
      const mp = (t.meio_pagamento || "Outros");
      const iniDate = toDate(ini);
      const fimDate = toDate(fim);
      return (st === "Aprovado")
          && (meio === "Todos" || mp === meio)
          && (!iniDate || d >= iniDate)
          && (!fimDate || d <= fimDate);
    });

    renderLista();
    $("lastUpdate").textContent="√öltima atualiza√ß√£o: "+new Date().toLocaleTimeString("pt-BR");
    $("statusResumo").innerHTML=`<div class="aprovado">Total Aprovados: ${TITULOS.length}</div>`;
  }catch(e){console.error(e);}
  finally{
    if(auto){$("miniSpinner").classList.remove("active");}
    else{$("overlay").classList.remove("active");}
  }
}

$("btnTotais").onclick = () => {
  const wrapper = $("totaisWrapper");
  wrapper.classList.toggle("active");
  if(wrapper.classList.contains("active")){
    const totais = {};
    TITULOS.forEach(t => {
      const meio = t.meio_pagamento || "Outros";
      const valor = Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",",".")) || 0;
      totais[meio] = (totais[meio] || 0) + valor;
    });
    wrapper.innerHTML = "";
    Object.entries(totais).forEach(([meio, valor]) => {
      const card = document.createElement("div");
      card.className = "total-card";
      card.innerHTML = `<span>${meio}</span><span>${BRL(valor)}</span>`;
      wrapper.appendChild(card);
    });
    const totalGeral = Object.values(totais).reduce((a,b)=>a+b,0);
    const cardTotal = document.createElement("div");
    cardTotal.className = "total-card";
    cardTotal.style.background = "linear-gradient(90deg,var(--blue),var(--green))";
    cardTotal.innerHTML = `<span>Total</span><span>${BRL(totalGeral)}</span>`;
    wrapper.appendChild(cardTotal);
  }
};

(function boot(){
  const hoje=iso(new Date());
  flatpickr("#filtroPeriodo",{
    mode:"range",
    dateFormat:"d/m/Y",
    locale:"pt",
    defaultDate:[hoje,hoje],
    onClose:()=>refresh(false)
  });
  $("barraPesquisa").addEventListener("input", ()=>renderLista());
  ["filtroMeio","filtroEmpresa"].forEach(id=>{$(id).onchange=()=>refresh(false);});
  refresh(false);
  setInterval(()=>refresh(true),10*1000);
})();
</script>
</body>
</html>
