<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel Financeiro • Aprovados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
    --green:#16a34a;--red:#ef4444;--amber:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink);font-size:15px}

  header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,#0f172a,#0b1220);
    border-bottom:1px solid var(--line);padding:14px}
  header h1{font-size:18px;margin:0 0 12px 0;font-weight:800}

  .row-filtros{display:flex;gap:8px;width:100%}
  select,input{background:#0b1528;border:1px solid #22314b;color:var(--ink);
    padding:10px 14px;border-radius:10px;font-size:15px;width:100%}

  .container{padding:16px;max-width:100%;margin:0 auto}

  .grafico-card{background:#0f172a;border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:20px}
  .grafico-card h2{font-size:16px;margin:0 0 10px;font-weight:700}

  .lista{display:flex;flex-direction:column;gap:12px;align-items:center}
  .titulo{width:98%;max-width:1200px;background:#101a2f;border:1px solid var(--line);
    border-radius:10px;padding:8px 14px;display:flex;flex-direction:column;gap:4px;position:relative}
  .topo{display:flex;align-items:center;justify-content:space-between}
  .ck{display:flex;align-items:center;gap:6px;color:var(--muted);font-size:13px}
  .ck input{width:18px;height:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap;font-size:14px;color:var(--muted)}
  .row b{color:var(--ink);font-size:15px}
  .pill{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .pill.aprovado{background:#0e2a1b;color:#b6f3c5;border:1px solid #155e32}
  .pill.negado{background:#2a0e0e;color:#ffb4b4;border:1px solid #7a1e1e}
  .pill.pendente{background:#2a2a0e;color:#fff2b2;border:1px solid #b59d00}
  .acoes{display:flex;justify-content:flex-end;margin-top:6px}
  .btn{padding:8px 14px;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;border:0}
  .liquidar{background:linear-gradient(180deg,#19c37d,#16a34a);color:#fff}

  .footer{position:fixed;left:0;right:0;bottom:0;padding:12px;background:#0f172a;border-top:1px solid var(--line);
    display:flex;justify-content:flex-end}
  .btn-massa{background:linear-gradient(180deg,#19c37d,#16a34a);color:#fff;border:0;border-radius:8px;
    padding:12px 18px;font-weight:800;cursor:pointer;font-size:15px}
</style>
</head>
<body>
<header>
  <h1>Painel Financeiro • Aprovados</h1>
  <div class="row-filtros">
    <select id="filtroStatus">
      <option value="Aprovado" selected>Aprovados</option>
      <option value="Negado">Negados</option>
      <option value="Liquidado">Liquidados</option>
    </select>
    <select id="filtroMeio">
      <option value="Todos" selected>Todos</option>
      <option value="Pix">Pix</option>
      <option value="Cartão">Cartão</option>
      <option value="Boleto">Boleto</option>
      <option value="Outros">Outros</option>
    </select>
    <input type="text" id="filtroPeriodo" placeholder="Selecione período" />
    <select id="filtroEmpresa">
      <option>CAP DELICIA</option>
      <option>CAP VILLA</option>
      <option>CAP PADARIA</option>
      <option>CAP MERCATTO</option>
      <option>CAP M.KIDS</option>
    </select>
  </div>
</header>

<div class="container">
  <!-- Card do gráfico -->
  <div class="grafico-card">
    <h2>Status por Empresa</h2>
    <canvas id="graficoStatus"></canvas>
  </div>

  <!-- Lista -->
  <div id="lista" class="lista"></div>
</div>

<div class="footer">
  <button id="btnMassa" class="btn-massa">✓ Liquidar Selecionados</button>
</div>

<script>
const endpoint="https://script.google.com/macros/s/AKfycbzzLGp4BH0X3-mdhMqG_e07wrnUo9yFXUmJ8wdP9iVVgPxk1-tnmjsCIAEAb7r_0_yd/exec";
const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso = d => {const dt=new Date(d);dt.setMinutes(dt.getMinutes()-dt.getTimezoneOffset());return dt.toISOString().slice(0,10);};

let TITULOS=[],SELEC=[],chart;

function renderLista(){
  const lista=$("lista");lista.innerHTML="";SELEC=[];
  TITULOS.forEach(t=>{
    const card=document.createElement("div");
    card.className="titulo";card.dataset.linha=t.linha;card.dataset.emp=t.empresa;
    const valor=Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",","."))||0;
    card.dataset.valor=valor;

    let st=t.status||"";
    let pillClass=st.toLowerCase();
    card.innerHTML=`
      <div class="topo">
        <label class="ck"><input type="checkbox" onchange="toggleSel(this)"> Selecionar</label>
        <span class="pill ${pillClass}">${st}</span>
      </div>
      <div><b>${t.fornecedor}</b> • ${t.empresa}</div>
      <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> • Meio: <b>${t.meio_pagamento||"Outros"}</b></div>
      <div class="row">Valor: <b>${BRL(valor)}</b></div>
      <div class="acoes"><button class="btn liquidar" onclick="liquidar(this)">✓ Liquidar</button></div>
    `;
    lista.appendChild(card);
  });
}

function toggleSel(chk){
  const card=chk.closest(".titulo");
  if(chk.checked)SELEC.push(card);else SELEC=SELEC.filter(c=>c!==card);
}

async function liquidar(btn){
  const card=btn.closest(".titulo");
  const emp=card.dataset.emp,linha=card.dataset.linha;
  try{
    await fetch(`${endpoint}?action=atualizar&empresa=${encodeURIComponent(emp)}&linha=${linha}&status=Liquidado`);
    card.querySelector(".pill").textContent="Liquidado";
    card.querySelector(".pill").className="pill liquidado";
  }catch(e){console.error(e);}
}

async function liquidarMassa(){
  for(const card of SELEC){
    const emp=card.dataset.emp,linha=card.dataset.linha;
    try{
      await fetch(`${endpoint}?action=atualizar&empresa=${encodeURIComponent(emp)}&linha=${linha}&status=Liquidado`);
      card.querySelector(".pill").textContent="Liquidado";
      card.querySelector(".pill").className="pill liquidado";
    }catch(e){console.error(e);}
  }
  SELEC=[];
}
$("btnMassa").onclick=liquidarMassa;

async function refresh(){
  const status=$("filtroStatus").value;
  const meio=$("filtroMeio").value;
  const empresa=$("filtroEmpresa").value;
  const periodo=$("filtroPeriodo").value;
  const [ini,fim]=periodo.includes(" to ")?periodo.split(" to "):[periodo,periodo];

  const r=await fetch(`${endpoint}?action=listar&empresa=${encodeURIComponent(empresa)}`);
  const data=await r.json();
  TITULOS=(data.titulos||data).filter(t=>{
    const d=iso(t.vencimento);
    const st=t.status||"";
    const mp=(t.meio_pagamento||"Outros");
    return (!status||st===status)&&
           (meio==="Todos"||mp===meio)&&
           (!ini||d>=ini)&&(!fim||d<=fim);
  });
  renderLista();
  atualizarGrafico(data.titulos||data);
}

function atualizarGrafico(dados){
  const counts={Aprovado:0,Pendente:0,Negado:0};
  dados.forEach(t=>{if(counts[t.status]!==undefined)counts[t.status]++;});
  const ctx=$("graficoStatus").getContext("2d");
  if(chart)chart.destroy();
  chart=new Chart(ctx,{
    type:"doughnut",
    data:{
      labels:["Aprovado","Pendente","Negado"],
      datasets:[{
        data:[counts.Aprovado,counts.Pendente,counts.Negado],
        backgroundColor:["#16a34a","#f59e0b","#ef4444"]
      }]
    },
    options:{plugins:{legend:{labels:{color:"#e5f0ff"}}}}
  });
}

(function boot(){
  const hoje=iso(new Date());
  flatpickr("#filtroPeriodo",{mode:"range",dateFormat:"Y-m-d",defaultDate:[hoje,hoje],onClose:()=>refresh()});
  ["filtroStatus","filtroMeio","filtroEmpresa"].forEach(id=>$(id).onchange=refresh);
  refresh();
})();
</script>
</body>
</html>
