<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Painel Financeiro • CAP</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
  :root{
    --bg:#0b1220;--card:#0f172a;--ink:#e5f0ff;--muted:#a8b3c7;--line:#243043;
    --teal:#06b6d4;--blue:#4f46e5;--green:#16a34a;--red:#ef4444;--amber:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:20;background:#0f172a;
    border-bottom:1px solid var(--line);padding:10px;display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
  header h1{margin:0;font-size:15px;font-weight:800}
  .controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
  select,input{background:#0b1528;border:1px solid #22314b;color:var(--ink);
    padding:6px 8px;border-radius:8px;font-size:13px}
  .btn{padding:6px 10px;border-radius:8px;background:#0b1528;border:1px solid #22314b;color:var(--ink);cursor:pointer;font-weight:700}

  .container{padding:12px;max-width:1000px;margin:0 auto}
  .mods{display:grid;gap:10px;margin-bottom:14px}
  @media(min-width:600px){.mods{grid-template-columns:repeat(3,1fr)}}
  .mod{border-radius:12px;padding:14px;font-weight:800;color:#fff;display:flex;justify-content:space-between;align-items:center}
  .cartao{background:linear-gradient(180deg,#4f46e5,#312e81)}
  .boleto{background:linear-gradient(180deg,#a855f7,#6b21a8)}
  .pix{background:linear-gradient(180deg,#06b6d4,#0e7490)}
  .outros{background:linear-gradient(180deg,#64748b,#1e293b)}
  .total{background:#0f172a;border:1px solid var(--line)}

  .list-head{display:flex;justify-content:space-between;align-items:center}
  .lista{display:grid;gap:12px;margin-top:10px}
  .titulo{background:#0f172a;border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px}
  .row{font-size:13px;color:var(--muted)}
  .row b{color:var(--ink)}
  .pill{padding:3px 8px;border-radius:999px;border:1px solid #2a3955;font-size:12px;font-weight:800}
  .pill.ok{background:#0e2a1b;color:#b6f3c5;border-color:#155e32}
  .pill.warn{background:#2a0e0e;color:#ffb4b4;border-color:#7a1e1e}
  .obsText,.historico{background:#0b1528;padding:6px;border-radius:8px;font-size:12px;color:#cbd5e1;white-space:pre-wrap}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
  .mini{flex:1;padding:8px;border-radius:8px;font-weight:800;border:0;cursor:pointer}
  .aprovar{background:linear-gradient(180deg,#19c37d,#16a34a);color:#04130b}
  .negar{background:linear-gradient(180deg,#fb6969,#ef4444);color:#2b0404}
  .obs{background:linear-gradient(180deg,#60a5fa,#1d4ed8)}
  .hist{background:linear-gradient(180deg,#ffd166,#f59e0b);color:#2a1500}
</style>
</head>
<body>
<header>
  <h1>Painel Financeiro • CAP</h1>
  <div class="controls">
    <select id="filtroStatus">
      <option value="Pendente">Pendentes</option>
      <option value="Aprovado">Aprovados</option>
      <option value="Negado">Negados</option>
      <option value="Liquidado">Liquidados</option>
      <option value="Todos" selected>Todos</option>
    </select>
    <input type="date" id="filtroData"/>
  </div>
</header>

<div class="container">
  <div id="mods" class="mods"></div>
  <div class="list-head">
    <b>Títulos</b><div id="contagem" style="font-size:12px;color:var(--muted)">0 itens</div>
  </div>
  <div id="lista" class="lista"></div>
</div>

<!-- modal observação -->
<div id="modalObs" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:center;justify-content:center">
  <div style="background:#0f172a;padding:12px;border-radius:10px;max-width:90%;width:400px">
    <h3>Observação</h3>
    <textarea id="textoObs" style="width:100%;min-height:80px;background:#0b1528;color:#fff;border:1px solid #22314b;border-radius:6px"></textarea>
    <button onclick="salvarObs()" class="btn" style="margin-top:6px">Salvar</button>
    <button onclick="fecharObs()" class="btn" style="margin-top:6px">Fechar</button>
  </div>
</div>

<script>
const endpointTitulos="SEU_ENDPOINT_AQUI";
let TITULOS=[],obsContext={};

const $=id=>document.getElementById(id);
const BRL=n=>(isNaN(n)?0:n).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});
const iso=d=>new Date(d).toISOString().slice(0,10);

async function loadTitulos(){
  const r=await fetch(`${endpointTitulos}?action=listar&empresa=CAP DELICIA`);
  const d=await r.json();
  TITULOS=d.titulos||[];
  render();
}

function render(){
  const lista=$("lista");lista.innerHTML="";let soma={Cartão:0,Boleto:0,Pix:0,Outros:0},total=0;
  const filtro=$("filtroStatus").value, dia=$("filtroData").value;
  TITULOS.forEach((t,i)=>{
    const st=t.status==="Sim"?"Pendente":t.status;
    if(filtro!=="Todos"&&st!==filtro)return;
    if(dia&&iso(t.vencimento)!==dia)return;
    const valor=Number(String(t.valor).replace("R$","").replace(/\./g,"").replace(",","."));
    total+=valor;
    const meio=(t.meio_pagamento||"").toLowerCase();
    if(meio.includes("cart"))soma.Cartão+=valor;
    else if(meio.includes("bol"))soma.Boleto+=valor;
    else if(meio.includes("pix"))soma.Pix+=valor;
    else soma.Outros+=valor;

    const card=document.createElement("div");
    card.className="titulo";
    card.innerHTML=`
      <div class="row"><b>${t.fornecedor}</b></div>
      <div class="row">Venc: <b>${iso(t.vencimento).split("-").reverse().join("/")}</b> • Meio: <b>${t.meio_pagamento}</b></div>
      <div class="row">Valor: <b>${BRL(valor)}</b> <span class="pill">${st}</span></div>
      ${t.observacao?`<div class="obsText"><b>Obs:</b> ${t.observacao}</div>`:""}
      ${t.historico?`<div class="historico"><b>Histórico:</b><br>${t.historico}</div>`:""}
      <div class="actions">
        <button class="mini aprovar" onclick="acaoStatus(${i},'Aprovado')">Aprovar</button>
        <button class="mini negar" onclick="acaoStatus(${i},'Negado')">Negar</button>
        <button class="mini obs" onclick="abrirObs(${i})">Obs</button>
        <button class="mini hist" onclick="alert('Histórico local ainda não implementado')">Hist</button>
      </div>`;
    lista.appendChild(card);
  });
  $("contagem").textContent=`${lista.children.length} itens`;
  renderModalidades(soma,total);
}

function renderModalidades(soma,total){
  const mods=$("mods");mods.innerHTML="";
  [["Cartão","cartao"],["Boleto","boleto"],["Pix","pix"],["Outros","outros"]].forEach(([k,cls])=>{
    const d=document.createElement("div");d.className=`mod ${cls}`;
    d.innerHTML=`<span>${k}</span><b>${BRL(soma[k])}</b>`;mods.appendChild(d);
  });
  const tot=document.createElement("div");tot.className="mod total";
  tot.innerHTML=`<span>Total</span><b>${BRL(total)}</b>`;mods.appendChild(tot);
}

/* ações */
async function acaoStatus(i,novo){
  TITULOS[i].status=novo;
  await fetch(`${endpointTitulos}?action=atualizar&empresa=CAP DELICIA&index=${i}&status=${novo}`);
  render();
}
function abrirObs(i){obsContext=i;$("textoObs").value=TITULOS[i].observacao||"";$("modalObs").style.display="flex"}
function fecharObs(){$("modalObs").style.display="none"}
async function salvarObs(){const i=obsContext;const txt=$("textoObs").value;TITULOS[i].observacao=txt;await fetch(`${endpointTitulos}?action=atualizarObservacao&empresa=CAP DELICIA&index=${i}&texto=${encodeURIComponent(txt)}`);fecharObs();render()}

$("filtroStatus").onchange=render;
$("filtroData").onchange=render;
loadTitulos();
</script>
</body>
</html>
